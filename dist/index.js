var C=class{static kebabToCamel(n){return n.replace(/-([a-z])/g,function(t){return t[1].toUpperCase()})}static camelToKebab(n){return n.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g,"$1-$2").toLowerCase()}static getRandomVariation(){return 1+(Math.random()*.2-.1)}static getRandomInt(n,t){return Math.floor(Math.random()*(t-n+1))+n}static mapRange(n,t,e,i,s){return i+(s-i)*(n-t)/(e-t)}static bezier(n,t,e,i){return(1-n)*(1-n)*t+2*(1-n)*n*e+n*n*i}};var V=[{property:"animate",type:"boolean",default:!0,description:"Whether or not to animate the highlights. A highlight with animate = false will display as soon as the page is loaded. When animate = true, the highlight will appear based on the animationSpeed and highlightDelay settings."},{property:"animationSpeed",type:"number",min:100,max:1e5,default:5e3,description:"The speed of the animation in milliseconds, the time taken between when the animation starts and when the highlight reaches the end of the text."},{property:"animationTrigger",type:"enum",validValues:["load","scrollIntoView"],default:"load",description:'The event that triggers the animation. "load" means the animation will start as soon as the page is loaded. "scrollIntoView" means the animation will start when the element is scrolled into view.'},{property:"height",type:"number",min:0,default:1,description:"The height of the highlight. 1 means the highlight will be the same height as the text. 0.5 means the highlight will be half the height of the text. 2 means the highlight will be twice the height of the text and so on. This will not be affected by the CSS line-height property, only the visual height of the text."},{property:"offset",type:"number",min:-5,max:5,default:0,description:"The vertical offset of the highlight. 0 means the highlight will be positioned directly on top of the text. -1 means the highlight will be positioned 1 line above the text. 1 means the highlight will be positioned 1 line below the text. Works nicely in tandem with the height property for e.g. overline, underline, strikethrough effects."},{property:"padding",type:"number",min:-10,max:10,default:0},{property:"highlight",type:"object",scalarField:"wavelength",expectedProperties:[{name:"wavelength",type:"number",min:0,max:50,default:1,description:"The wavelength of the wave. 1 means the wave will be a single wave across the entire highlight. 2 means the wave will have 2 waves across the highlight."},{name:"amplitude",type:"number",min:0,max:50,default:.25,description:"The amplitude of the wave. 0.5 means the wave will be half the height of the highlight. 1 means the wave will be the same height as the highlight."},{name:"roughEnds",type:"number",min:0,max:500,default:5,description:"The roughness of the wave ends. 0 means the wave will have smooth ends. 1 means the wave will have rough ends."},{name:"jitter",type:"number",min:0,max:25,default:.1,description:"The jitter of the wave. 0 means no jitter, 1 means the wave will be very jittery."}],default:{wavelength:1}},{property:"circle",type:"object",scalarField:"curve",expectedProperties:[{name:"curve",type:"number",min:0,max:1,default:.5,description:"Controls the shape of the circle. 0 for square, 0.5 for rounded corners, 1 for ellipse."},{name:"wobble",type:"number",min:0,max:1,default:.3,description:"The amount of irregularity in the circle. 0 for perfect shape, 1 for maximum wobble."},{name:"loops",type:"number",min:1,max:10,default:3,description:"The number of loops to draw around the text."},{name:"thickness",type:"number",min:1,max:10,default:2,description:"The base thickness of the pen stroke. Actual thickness varies along the path."}],default:{curve:.5,wobble:.3,loops:3,thickness:5}},{property:"burst",type:"object",scalarField:"power",expectedProperties:[{name:"style",type:"enum",validValues:["lines","burst","curve","cloud"],default:"lines"},{name:"power",type:"number",min:.1,max:5,default:1},{name:"count",type:"number",min:3,max:500,default:10},{name:"randomness",type:"number",min:0,max:1,default:.5}],default:{style:"lines",power:1,count:10,randomness:.5}},{property:"wavelength",type:"number",min:0,max:500,default:1},{property:"amplitude",type:"number",min:0,max:500,default:.5},{property:"easing",type:"enum",validValues:["ease","linear","ease-in","ease-out","ease-in-out"],default:"ease",description:'The easing function to use for the animation. Accepted values are "ease", "linear", "ease-in", "ease-out", "ease-in-out".'},{property:"drawingMode",type:"enum",validValues:["highlight","circle","burst","scribble","sketchout"],default:"highlight",description:"The drawing mode to use for the highlight. Options: highlight (wavy marker), circle (hand-drawn circle), burst (radiating lines), scribble (messy scribble), sketchout (sketchy rectangle outline)"},{property:"debug",type:"boolean",default:!1,description:"When true, adds debugging features like highlight borders and option popups on hover"},{property:"skewX",type:"number",min:-10,max:10,default:0,description:"Skews the highlight horizontally by the specified amount (in units of line height)"},{property:"skewY",type:"number",min:-10,max:10,default:0,description:"Skews the highlight vertically by the specified amount (in units of line height)"},{property:"multiLineDelay",type:"number",min:0,max:1,default:0,description:"Controls the delay between multiline highlights. 0 means all lines start at once, 1 means each line waits for the previous to finish"},{property:"delay",type:"number",min:0,max:6e4,default:0,description:"Delay in milliseconds before starting the highlight animation"}],N=class{constructor(){}validate(n){let t={},e=new Set(V.map(i=>i.property));for(let i in n)e.has(i)||console.error(`Unknown option '${i}' provided. This option is not defined in the validation rules.`);return V.forEach(i=>{let s=n[i.property];s===void 0&&(s=i.default),i.type==="object"&&i.expectedProperties?(i.scalarField&&(typeof s!="object"||s===null)?s={[i.scalarField]:s}:(typeof s!="object"||s===null)&&(s={}),i.expectedProperties.forEach(a=>{s[a.name]===void 0&&(s[a.name]=a.default)}),this.validateObjectProperties(s,i.expectedProperties,i.property)):this.validateValue(s,i),t[i.property]=s}),t}validateObjectProperties(n,t,e){t?.forEach(i=>{let s=n[i.name];s=this.validateValue(s,{...i,property:`${e}.${i.name}`})})}validateValue(n,t){switch(t.type){case"boolean":if(typeof n!="boolean")return t.default;break;case"number":if(n=parseFloat(n),isNaN(n)||t.min!==void 0&&n<t.min||t.max!==void 0&&n>t.max)return t.default;break;case"enum":if(!t.validValues?.includes(n))return t.default;break}}extractAttributes(n){let t={};for(let e of V){let i=`data-${C.camelToKebab(e.property)}`,s=n.getAttribute(i);if(s!==null)switch(e.type){case"boolean":t[e.property]=s==="true";break;case"number":let a=parseFloat(s);t[e.property]=isNaN(a)?void 0:a;break;case"object":try{t[e.property]=JSON.parse(s)}catch{continue}break;case"enum":e.validValues?.includes(s)&&(t[e.property]=s);break;default:t[e.property]=s;break}}return t}validateElement(n){let t=this.extractAttributes(n);return this.validate(t)}};var D=class{constructor(n,t){this.rect=n,this.mark=t}isTerminatingWithinText(){let n=document.createRange();n.setStartAfter(this.mark),n.setEndAfter(this.mark.nextSibling||this.mark);let t=Array.from(n.getClientRects());return t.length>0?t[0].left>this.rect.right:!1}isStartingWithinText(){let n=document.createRange();n.setStartBefore(this.mark),n.setEndBefore(this.mark);let t=Array.from(n.getClientRects());return t.length>0?t[t.length-1].right<this.rect.left:!1}};var R=class T{constructor(n){if(n.startsWith("#"))this.fromHex(n);else if(n.startsWith("rgb"))this.fromRgb(n);else throw new Error("Unsupported color format")}copy(){return new T(this.toRgb())}fromHex(n){let t=parseInt(n.slice(1),16);this.r=t>>16&255,this.g=t>>8&255,this.b=t&255}fromRgb(n){let[t,e,i]=n.match(/\d+/g).map(Number);this.r=t,this.g=e,this.b=i}toHex(){return"#"+(1<<24|this.r<<16|this.g<<8|this.b).toString(16).slice(1).toUpperCase()}toRgb(){return`rgb(${this.r}, ${this.g}, ${this.b})`}rgbToHsl(n,t,e){n/=255,t/=255,e/=255;let i=Math.max(n,t,e),s=Math.min(n,t,e),a,o,r=(i+s)/2;if(i===s)a=o=0;else{let h=i-s;switch(o=r>.5?h/(2-i-s):h/(i+s),i){case n:a=(t-e)/h+(t<e?6:0);break;case t:a=(e-n)/h+2;break;case e:a=(n-t)/h+4;break;default:a=0;break}a/=6}return[a,o,r]}hslToRgb(n,t,e){let i,s,a;if(t===0)i=s=a=e;else{let o=(d,c,l)=>(l<0&&(l+=1),l>1&&(l-=1),l<.16666666666666666?d+(c-d)*6*l:l<.5?c:l<.6666666666666666?d+(c-d)*(.6666666666666666-l)*6:d),r=e<.5?e*(1+t):e+t-e*t,h=2*e-r;i=o(h,r,n+1/3),s=o(h,r,n),a=o(h,r,n-1/3)}return[Math.round(i*255),Math.round(s*255),Math.round(a*255)]}lighten(n){let[t,e,i]=this.rgbToHsl(this.r,this.g,this.b),s=Math.max(0,e*(1-n/200)),a=Math.min(1,i+n/100*(1-i));return[this.r,this.g,this.b]=this.hslToRgb(t,s,a),this}darken(n){let[t,e,i]=this.rgbToHsl(this.r,this.g,this.b),s=Math.min(1,e*(1+n/200)),a=Math.max(0,i*(1-n/100));return[this.r,this.g,this.b]=this.hslToRgb(t,s,a),this}as(n){switch(n){case"rgb":return this.toRgb();case"hex":return this.toHex();default:throw new Error("Unsupported format")}}get rgb(){return this.toRgb()}get hex(){return this.toHex()}};var M=class{constructor({options:n,color:t,rect:e}){this.isAnimating=!1;this.animationStartTime=null;this.animationProgress=0;this.animationDuration=1e3;this.lastStepTime=null;this.accumulatedTime=0;this.isCompleted=!1;this.lastProgress=0;this.options=n,this.color=t,this.rect=e,this.canvas=this.createCanvas(0),this.ctx=this.canvas.getContext("2d")}createCanvas(n){let t=this.rect.rect,e=document.createElement("canvas");e.width=t.width+2*n,e.height=t.height+2*n;let i=e.getContext("2d");if(!i)throw new Error("Failed to get 2D context");return i.clearRect(0,0,e.width,e.height),e}startAnimation(n=!1){this.isAnimating=!n&&!this.isCompleted,this.animationStartTime=null,this.animationProgress=n?1:0,n&&(this.step(0,1),this.isCompleted=!0)}animate(n){if(!this.isAnimating)return!1;this.animationStartTime===null&&(this.animationStartTime=n,this.lastProgress=0);let t=n-this.animationStartTime;return this.animationProgress=Math.min(t/this.animationDuration,1),this.animationProgress>this.lastProgress&&(this.step(this.lastProgress,this.animationProgress),this.lastProgress=this.animationProgress),this.animationProgress>=1?(this.isAnimating=!1,this.isCompleted=!0,!1):!0}redrawFull(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.step(0,1)}};var A=class extends M{constructor(t){super(t);this.TOTAL_POINTS=100;this.lineHeight=1;this.linesVariables={};this.animationDuration=this.options.animationSpeed;let e=this.rect.rect;this.maxFrayOffset=4*(this.options.highlight.roughEnds||0),this.paddingAmount=this.calculatePadding(e),this.highlightHeight=e.height*(this.options.height||1),this.lineCount=Math.ceil(this.highlightHeight/this.lineHeight),this.verticalOffset=(e.height-this.highlightHeight)/2;for(let s=0;s<this.lineCount;s++)this.linesVariables[`line${s}`]=Math.random();let i=this.calculateCanvasHeight(e);this.canvas=this.makeCanvas(this.paddingAmount+this.maxFrayOffset,i),this.ctx=this.canvas.getContext("2d",{willReadFrequently:!1}),this.ctx.imageSmoothingEnabled=!0,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.pointsData=this.generatePointsData()}calculatePadding(t){return(this.options.padding||0)*t.height}calculateCanvasHeight(t){let e=this.options.highlight.amplitude*t.height,i=Math.max(e,t.height*.2);return this.highlightHeight+2*i}setBounds(){let t=this.rect.rect,e=this.options.highlight.amplitude*t.height,i=Math.max(e,t.height*.2),s=(this.canvas.height-t.height)/2;return{canvas:this.canvas,height:this.canvas.height,verticalOffset:i-this.verticalOffset,horizontalPadding:this.paddingAmount}}generatePointsData(){let t=this.rect.rect,e=this.options.highlight.wavelength*t.height,i=this.options.highlight.amplitude*t.height/10;return Array.from({length:this.lineCount},(s,a)=>{let o=this.maxFrayOffset*(this.rect.isStartingWithinText()?.1:1)*Math.random(),h=t.width+this.paddingAmount*2-this.maxFrayOffset*(this.rect.isTerminatingWithinText()?.1:1)*Math.random()-o;return Array.from({length:this.TOTAL_POINTS+1},(d,c)=>{let l=c/this.TOTAL_POINTS,g=o+l*h,u=(g-o)/e,p=this.getVerticalPosition(a)+Math.sin(u*2*Math.PI)*i*this.randomFactor();return{x:g,y:p}})})}step(t,e){for(let i=0;i<this.lineCount;i++){let s=this.pointsData[i],a=Math.floor(t*this.TOTAL_POINTS),o=Math.min(Math.ceil(e*this.TOTAL_POINTS),this.TOTAL_POINTS);this.ctx.beginPath(),this.ctx.strokeStyle=this.getLineGradient(i),this.ctx.lineWidth=this.lineHeight*2;for(let r=a;r<=o;r++){let h=s[r];r===a?this.ctx.moveTo(h.x,h.y):this.ctx.lineTo(h.x,h.y)}this.ctx.stroke()}}getVerticalPosition(t){return t*this.lineHeight+this.lineHeight/2+(this.canvas.height-this.highlightHeight)/2}getLineGradient(t){let e=this.rect.rect,i=10,a=this.linesVariables[`line${t}`]*10,o=C.mapRange(t,0,this.lineCount,0,i),r=this.color.copy().lighten(o+a),h=this.color.copy().darken(o+a),d=this.ctx.createLinearGradient(0,0,e.width,0);return d.addColorStop(0,r.rgb),d.addColorStop(1,h.rgb),d}randomFactor(){return 1}makeCanvas(t,e){let i=document.createElement("canvas");return i.width=this.rect.rect.width+2*t,i.height=e,i}};var I=class extends M{constructor(t){super(t);this.TOTAL_POINTS=100;this.lines=[];this.lineCount=3;this.animationDuration=this.options.animationSpeed||1e3;let e=this.rect.rect;this.padding=e.height*.5,this.lineWidth=e.height*.1,this.canvas=this.createCanvas(this.padding),this.ctx=this.canvas.getContext("2d"),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.generateLines()}generateLines(){let t=this.rect.rect,e=this.lineWidth*1.5,i=t.height*.3,s=this.color.copy().lighten(10),a=this.color;for(let o=0;o<this.lineCount;o++){let r=this.canvas.height/2+(o-1)*e,h=[];for(let l=0;l<=this.TOTAL_POINTS;l++){let g=l/this.TOTAL_POINTS,u=this.padding+g*t.width,p=(Math.sin(g*Math.PI*4+o)*.5+(Math.random()-.5)*.5)*i,b=r+p;h.push({x:u,y:b})}let c=o/(this.lineCount-1)<.5?s.copy():a.copy();this.lines.push({points:h,color:this.color.rgb})}}setBounds(){let t=this.rect.rect;return{canvas:this.canvas,height:t.height+2*this.padding,verticalOffset:this.padding,horizontalPadding:this.padding}}step(t,e){let i=Math.floor(t*this.TOTAL_POINTS),s=Math.min(Math.ceil(e*this.TOTAL_POINTS),this.TOTAL_POINTS);this.ctx.lineWidth=this.lineWidth;for(let a of this.lines){this.ctx.strokeStyle=a.color,this.ctx.beginPath();for(let o=i;o<=s;o++){let r=a.points[o];o===i?this.ctx.moveTo(r.x,r.y):this.ctx.lineTo(r.x,r.y)}this.ctx.stroke()}}};var k=class extends M{constructor(t){super(t);this.POINTS_PER_SIDE=25;this.pathPoints=[];this.lineWidth=2;this.animationDuration=this.options.animationSpeed||1e3;let e=this.rect.rect;this.padding=e.height*.3,this.canvas=this.createCanvas(this.padding),this.ctx=this.canvas.getContext("2d"),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.generatePath()}generatePath(){let t=this.rect.rect,e=t.height*.05,i=this.padding,s=this.padding+t.width,a=this.padding,o=this.padding+t.height;for(let r=0;r<=this.POINTS_PER_SIDE;r++){let h=r/this.POINTS_PER_SIDE;this.pathPoints.push({x:i+h*t.width+(Math.random()-.5)*e,y:a+(Math.random()-.5)*e})}for(let r=1;r<=this.POINTS_PER_SIDE;r++){let h=r/this.POINTS_PER_SIDE;this.pathPoints.push({x:s+(Math.random()-.5)*e,y:a+h*t.height+(Math.random()-.5)*e})}for(let r=1;r<=this.POINTS_PER_SIDE;r++){let h=r/this.POINTS_PER_SIDE;this.pathPoints.push({x:s-h*t.width+(Math.random()-.5)*e,y:o+(Math.random()-.5)*e})}for(let r=1;r<this.POINTS_PER_SIDE;r++){let h=r/this.POINTS_PER_SIDE;this.pathPoints.push({x:i+(Math.random()-.5)*e,y:o-h*t.height+(Math.random()-.5)*e})}}setBounds(){let t=this.rect.rect;return{canvas:this.canvas,height:t.height+2*this.padding,verticalOffset:this.padding,horizontalPadding:this.padding}}step(t,e){let i=this.pathPoints.length,s=Math.floor(t*i),a=Math.min(Math.ceil(e*i),i-1);if(!(s>=a)){this.ctx.strokeStyle=this.color.rgb,this.ctx.lineWidth=this.lineWidth,this.ctx.beginPath();for(let o=s;o<=a;o++){let r=this.pathPoints[o];o===s?this.ctx.moveTo(r.x,r.y):this.ctx.lineTo(r.x,r.y)}this.ctx.stroke()}}};var L=class extends M{constructor(t){super(t);this.controlPoints=[];this.totalPoints=200;this.pathSegments=[];this.animationDuration=this.options.animationSpeed||1e3;let e=this.rect.rect;this.padding=Math.max(e.height,e.width)*.4,this.canvas=this.createCanvas(this.padding),this.ctx=this.canvas.getContext("2d"),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.generateControlPoints(),this.generatePathSegments()}generateControlPoints(){let t=this.rect.rect,{curve:e}=this.options.circle,i=this.canvas.width/2,s=this.canvas.height/2,a=this.options.padding*t.height,o=t.width/2+a+t.height*.3,r=t.height/2*this.options.height+t.height*.4,h=64;for(let d=0;d<h;d++){let c=d/h*Math.PI*2,l=o*Math.cos(c),g=r*Math.sin(c),u=2+(1-e)*6,p=o*Math.sign(Math.cos(c))*Math.pow(Math.abs(Math.cos(c)),2/u),b=r*Math.sign(Math.sin(c))*Math.pow(Math.abs(Math.sin(c)),2/u),v=i+p*(1-e)+l*e,m=s+b*(1-e)+g*e;this.controlPoints.push({x:v,y:m})}}generatePathSegments(){let{loops:t,thickness:e,wobble:i}=this.options.circle,s=this.totalPoints*t,a=10,o=Math.ceil(s/a),r={x:0,y:0},h=0,d=this.padding*.08;for(let c=0;c<o;c++){let l=c*a,g=Math.min((c+1)*a,s),u=[];for(let m=l;m<=g;m++){let y=m%this.totalPoints/this.totalPoints,f=m/s,x=(Math.sin(m*.1)*.5+(Math.random()-.5)*.5)*d,P=(Math.cos(m*.1)*.5+(Math.random()-.5)*.5)*d,O=(Math.sin(m*.05)*.5+(Math.random()-.5)*.5)*d,w=.1;r.x+=(x-r.x)*w,r.y+=(P-r.y)*w,h+=(O-h)*w;let E=this.getPointOnPath(y,h),$=this.getWobbleOffset(y,i,f);u.push({x:E.x+$.x+r.x,y:E.y+$.y+r.y})}let p=(l+g)/2/s,b=this.getThicknessFactor(p),v=this.getColorAtProgress(p);this.pathSegments.push({points:u,color:v.rgb,thickness:e*b})}}setBounds(){let t=this.rect.rect;return{canvas:this.canvas,height:t.height+2*this.padding,verticalOffset:this.padding,horizontalPadding:this.padding}}step(t,e){let i=this.pathSegments.length,s=Math.floor(t*i),a=Math.min(Math.ceil(e*i),i);for(let o=s;o<a;o++){let r=this.pathSegments[o];if(!(r.points.length<2)){this.ctx.strokeStyle=r.color,this.ctx.lineWidth=r.thickness,this.ctx.beginPath(),this.ctx.moveTo(r.points[0].x,r.points[0].y);for(let h=1;h<r.points.length;h++)this.ctx.lineTo(r.points[h].x,r.points[h].y);this.ctx.stroke()}}}getPointOnPath(t,e){let i=t*this.controlPoints.length,s=Math.floor(i),a=(s+1)%this.controlPoints.length,o=i-s,r=this.controlPoints[s],h=this.controlPoints[a];return{x:r.x+(h.x-r.x)*o+e,y:r.y+(h.y-r.y)*o+e}}getWobbleOffset(t,e,i){let o=2+i*4,r=e*.5,h=e*1.5,d=r+i*h,c=Math.sin(t*Math.PI*2*o)*d,l=Math.cos((t+.25)*Math.PI*2*o)*d;return{x:c,y:l}}getThicknessFactor(t){return t<.45?C.bezier(t/.5,.2,.2,1.2):C.bezier((t-.5)/.5,1.2,1,1)}getColorAtProgress(t){let e=new R(this.color.rgb),i=t*30;return e.darken(i)}};var H=class extends M{constructor(t){super(t);this.elements=[];this.padding=0;this.burstOptions={style:t.options.burst?.style||"lines",power:t.options.burst?.power||1,count:t.options.burst?.count||12,randomness:t.options.burst?.randomness||.3},this.animationDuration=this.options.animationSpeed||1e3,this.validateBurstOptions()}validateBurstOptions(){this.burstOptions.count<3&&(this.burstOptions.count=3),this.burstOptions.power<.1&&(this.burstOptions.power=.1),this.burstOptions.randomness<0&&(this.burstOptions.randomness=0),this.burstOptions.randomness>1&&(this.burstOptions.randomness=1)}setBounds(){let t=this.rect.rect;return this.padding=t.height*Math.max(2.5,this.burstOptions.power*2),this.canvas=this.createCanvas(this.padding),this.ctx=this.canvas.getContext("2d"),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.generateElements(),{canvas:this.canvas,height:t.height+2*this.padding,verticalOffset:this.padding,horizontalPadding:this.padding}}generateElements(){let t=this.rect.rect,e=this.canvas.width/2,i=this.canvas.height/2,s=t.height*.8,a=t.height*this.burstOptions.power*.75;switch(this.burstOptions.style){case"lines":case"burst":this.generateComicRays(e,i,t,s,a);break;case"curve":this.generateCurvedRays(e,i,t,s,a);break;case"cloud":this.generateCloudPuffs(e,i,t,s);break}}generateComicRays(t,e,i,s,a){let o=this.burstOptions.count,r=this.burstOptions.style==="burst";for(let h=0;h<o;h++){let d=h/o*Math.PI*2,c=(Math.random()-.5)*this.burstOptions.randomness*(Math.PI/o),l=d+c,g=i.width/2+s,u=i.height/2+s,p=t+g*Math.cos(l),b=e+u*Math.sin(l),v=.5+Math.random()*1,m=a*v,y=p+Math.cos(l)*m,f=b+Math.sin(l)*m,x=2+Math.random()*3;if(r){let P=m*.3*(Math.random()-.5),O=l+Math.PI/2,w=(p+y)/2+Math.cos(O)*P,E=(b+f)/2+Math.sin(O)*P;this.elements.push({type:"curve",points:[{x:p,y:b},{x:w,y:E},{x:y,y:f}],color:this.getRandomColor().rgb,lineWidth:x,drawn:!1})}else this.elements.push({type:"line",points:[{x:p,y:b},{x:y,y:f}],color:this.getRandomColor().rgb,lineWidth:x,drawn:!1})}}generateCurvedRays(t,e,i,s,a){let o=this.burstOptions.count;for(let r=0;r<o;r++){let h=r/o*Math.PI*2,d=(Math.random()-.5)*this.burstOptions.randomness*(Math.PI/o),c=h+d,l=i.width/2+s*1.2,g=i.height/2+s*1.2,u=t+l*Math.cos(c),p=e+g*Math.sin(c),b=.6+Math.random()*.8,v=a*b,m=r%2===0?1:-1,y=v*.4*m,f=c+Math.PI/2,x=u+Math.cos(c)*v,P=p+Math.sin(c)*v,O=(u+x)/2+Math.cos(f)*y,w=(p+P)/2+Math.sin(f)*y;this.elements.push({type:"curve",points:[{x:u,y:p},{x:O,y:w},{x,y:P}],color:this.getRandomColor().rgb,lineWidth:1.5+Math.random()*2.5,drawn:!1})}}generateCloudPuffs(t,e,i,s){let a=Math.max(30,this.burstOptions.count*3),o=i.height*.5,r=3;for(let h=0;h<r;h++){let d=s*.8+h*i.height*.5,c=Math.floor(a/r);for(let l=0;l<c;l++){let g=l/c*Math.PI*2,u=(Math.random()-.5)*.5,p=g+u,b=(Math.random()-.5)*i.height*.3,v=i.width/2+d+b,m=i.height/2+d+b,y=t+v*Math.cos(p),f=e+m*Math.sin(p),x=o+5;if(y<x||y>this.canvas.width-x||f<x||f>this.canvas.height-x)continue;let P=.3+Math.random()*.7,O=o*P*(1-h*.2);this.elements.push({type:"cloud",points:[{x:y,y:f}],color:this.getRandomCloudColor().rgb,lineWidth:Math.max(3,O),drawn:!1})}}for(let h=0;h<a/2;h++){let d=Math.random()*Math.PI*2,c=s+Math.random()*i.height*1.2,l=t+(i.width/2+c)*Math.cos(d),g=e+(i.height/2+c)*Math.sin(d),u=10;if(l<u||l>this.canvas.width-u||g<u||g>this.canvas.height-u)continue;let p=4+Math.random()*10;this.elements.push({type:"cloud",points:[{x:l,y:g}],color:this.getRandomCloudColor().rgb,lineWidth:p,drawn:!1})}}step(t,e){let i=Math.floor(t*this.elements.length),s=Math.min(Math.ceil(e*this.elements.length),this.elements.length);for(let a=i;a<s;a++){let o=this.elements[a];if(!o.drawn){switch(this.ctx.strokeStyle=o.color,this.ctx.fillStyle=o.color,this.ctx.lineWidth=o.lineWidth,o.type){case"line":this.drawLine(o);break;case"curve":this.drawCurve(o);break;case"cloud":this.drawCloud(o);break}o.drawn=!0}}}drawLine(t){let[e,i]=t.points;this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke()}drawCurve(t){let[e,i,s]=t.points;this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.quadraticCurveTo(i.x,i.y,s.x,s.y),this.ctx.stroke()}drawCloud(t){let{x:e,y:i}=t.points[0],s=t.lineWidth;this.ctx.beginPath(),this.ctx.arc(e,i,s,0,Math.PI*2),this.ctx.fill()}getRandomColor(){let t=new R(this.color.rgb),e=15*Math.random();return Math.random()>.5?t.lighten(e):t.darken(e)}getRandomCloudColor(){return new R(this.color.rgb).lighten(20+Math.random()*30)}};var z=class{static getRenderer({mode:n,options:t,color:e,rect:i}){switch(n){case"highlight":return new A({options:t,color:e,rect:i});case"burst":return new H({options:t,color:e,rect:i});case"scribble":return new I({options:t,color:e,rect:i});case"sketchout":return new k({options:t,color:e,rect:i});case"circle":return new L({options:t,color:e,rect:i});default:throw new Error(`Unsupported drawing mode: ${n}`)}}},F=z;var S=class S{constructor(n,t={}){this.debugTooltip=null;this.renderers=new Map;this.highlightDivs=new Map;this.animationFrameIds=new Map;this.observer=null;this.initialized=!1;if(n.hasAttribute("data-marker-initialized")){console.warn("MarkerHighlighter already initialized for this element");return}n.setAttribute("data-marker-initialized","true"),this.element=n,this.validator=new N,this.options=this.validator.validate(t),this.setupIntersectionObserver(),n.parentElement&&(window.getComputedStyle(n.parentElement).position==="static"&&(n.parentElement.style.position="relative"),n.parentElement.style.zIndex="0");let e=()=>{this.initialized||(this.initialized=!0,this.highlightText(!1))};document.fonts&&document.fonts.ready?document.fonts.ready.then(()=>{setTimeout(e,0)}):setTimeout(e,100),this.options.debug&&this.setupDebugMode(),this.addEventListeners()}static defineStyle(n,t){S.styles[n]=t}static getStyle(n){return S.styles[n]||{}}setupDebugMode(){this.debugTooltip=document.createElement("div"),this.debugTooltip.style.cssText=`
            position: fixed;
            padding: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 9999;
            display: none;
            max-width: 300px;
            white-space: pre-wrap;
        `,document.body.appendChild(this.debugTooltip),document.addEventListener("mousemove",n=>{if(!this.debugTooltip)return;let e=n.target.closest(".highlight");if(e){let i=e.getAttribute("data-mark-id");if(i){let s=document.querySelector(`[data-mark-ref="${i}"]`);if(s){let a=this.getElementOptions(s);this.debugTooltip.textContent=JSON.stringify(a,null,2),this.debugTooltip.style.display="block",this.debugTooltip.style.left=`${n.pageX+15}px`,this.debugTooltip.style.top=`${n.pageY+15}px`}}}else this.debugTooltip.style.display="none"})}getElementOptions(n){let t={...this.options},e=n.getAttribute("data-highlight-style")||n.getAttribute("my-style"),i=e?S.getStyle(e):{},s=this.validator.extractAttributes(n);return{base:t,style:i,element:s,final:{...t,...i,...s}}}setupIntersectionObserver(){this.observer=new IntersectionObserver(n=>{n.forEach(t=>{if(t.isIntersecting){let e=t.target,i=e.getAttribute("data-mark-id"),s=parseInt(e.getAttribute("data-segment-index")||"0");if(i){let a=document.querySelector(`[data-mark-ref="${i}"]`);if(a){let o=this.renderers.get(a);o&&o[s]&&!o[s].isCompleted&&this.startSegmentAnimation(a,s,!1)}}}})},{threshold:.5})}getRelativeOffset(n){let t=0,e=0,i=n.parentElement;for(;i&&i!==document.body;)window.getComputedStyle(i).position==="relative"&&(t+=i.offsetTop,e+=i.offsetLeft),i=i.parentElement;return{top:t,left:e}}getMarkDepth(n){let t=0,e=n;for(;e;)e.tagName==="MARK"&&t++,e=e.parentElement;return t}ensureTextVisibility(n){n.style.position="relative";let t="999999";n.style.zIndex=t;let e=n.previousSibling;for(;e;){if(e.nodeType===Node.TEXT_NODE){let i=document.createElement("span");i.style.position="relative",i.style.zIndex=t,i.textContent=e.textContent,e.parentNode?.replaceChild(i,e)}e=e.previousSibling}for(e=n.nextSibling;e;){if(e.nodeType===Node.TEXT_NODE){let i=document.createElement("span");i.style.position="relative",i.style.zIndex=t,i.textContent=e.textContent,e.parentNode?.replaceChild(i,e)}e=e.nextSibling}}clearExistingHighlights(){let n=this.element.parentElement;n&&(n.querySelectorAll(".highlight").forEach(s=>s.remove()),n.querySelectorAll("mark[data-mark-ref]").forEach(s=>{s.removeAttribute("data-mark-ref"),s.style.position="",s.style.zIndex=""}),n.querySelectorAll('span[style*="z-index: 999999"]').forEach(s=>{let a=document.createTextNode(s.textContent||"");s.parentNode?.replaceChild(a,s)})),this.stopAllAnimations(),this.highlightDivs.clear(),this.renderers.clear()}stopAllAnimations(){this.animationFrameIds.forEach((n,t)=>{n.forEach(e=>{e&&cancelAnimationFrame(e)}),this.animationFrameIds.delete(t)})}highlightText(n=!1){this.clearExistingHighlights(),this.renderers.clear(),this.element.querySelectorAll("mark").forEach((e,i)=>{let s=e.parentElement,a=e.getAttribute("id")||`mark-${i}`;e.setAttribute("data-mark-ref",a);let o={...this.options},r=e.getAttribute("data-highlight-style"),h=r?S.getStyle(r):{},d=this.validator.extractAttributes(e),c={...o,...h,...d},l=this.validator.validate(c),u=!(l.animate!==!1)||n;this.highlightMark(e,l,s,u,n)})}highlightMark(n,t,e,i,s){let a=document.createRange();a.selectNodeContents(n);let o=a.getClientRects(),r=this.getMarkDepth(n),h=r===1?1:1e3+r;this.ensureTextVisibility(n);let d=this.getRelativeOffset(n);if(!n.hasAttribute("data-original-bgcolor")){let p=getComputedStyle(n).backgroundColor;n.setAttribute("data-original-bgcolor",p)}n.style.backgroundColor="transparent";let c=new R(n.getAttribute("data-original-bgcolor")),l=n.getAttribute("data-mark-ref"),g=[],u=[];this.renderers.set(n,g),this.highlightDivs.set(n,u),Array.from(o).forEach((p,b)=>{try{let v=new D(p,n),m=document.createElement("div");m.className="highlight",m.style.zIndex=h.toString(),m.setAttribute("data-mark-id",l),m.setAttribute("data-segment-index",String(b));let y=F.getRenderer({mode:t.drawingMode,options:t,color:c,rect:v});g.push(y),u.push(m);let f=y.setBounds();m.appendChild(f.canvas);let x=0,P=t.offset*p.height/2,O=f.verticalOffset;if(t.skewX||t.skewY){let w=(t.skewX||0)*p.height,E=(t.skewY||0)*p.height;m.style.transform=`skew(${w}deg, ${E}deg)`,m.style.transformOrigin="center"}if(O+=p.height*.1,m.style.position="absolute",m.style.top=`${p.top+window.scrollY-O+x+P-d.top}px`,m.style.left=`${p.left+window.scrollX-f.horizontalPadding-d.left}px`,m.style.width=`${p.width+2*f.horizontalPadding}px`,m.style.height=`${Math.max(p.height,f.height)}px`,m.style.pointerEvents="none",e&&e.appendChild(m),t.animationTrigger==="scrollIntoView")if(s){let w=m.getBoundingClientRect();w.top>=0&&w.bottom<=window.innerHeight?this.startSegmentAnimation(n,b,!0):this.observer?.observe(m)}else this.observer?.observe(m);else this.startSegmentAnimation(n,b,i);this.options.debug&&(m.style.border="1px dashed red")}catch(v){console.error(v)}})}startSegmentAnimation(n,t,e){let i=this.renderers.get(n);if(!i||!i[t])return;let s=this.getElementOptions(n).final,a=s.delay||0,o=s.multiLineDelay||0,r=a+o*t*s.animationSpeed;setTimeout(()=>{let h=i[t];if(h.startAnimation(e),!e){let d=l=>{if(h.animate(l)){let u=this.animationFrameIds.get(n)||[];u[t]=requestAnimationFrame(d),this.animationFrameIds.set(n,u)}else{let u=this.animationFrameIds.get(n);u&&(u[t]=0,u.some(p=>p!==0)||this.animationFrameIds.delete(n))}},c=this.animationFrameIds.get(n)||new Array(i.length).fill(0);c[t]=requestAnimationFrame(d),this.animationFrameIds.set(n,c)}},r)}setOption(n,t){this.options[n]=t}setOptions(n){this.options={...this.options,...n}}reanimateMark(n){let t=this.renderers.get(n);t&&(t.forEach(e=>{e.isCompleted=!1}),t.forEach((e,i)=>{this.startSegmentAnimation(n,i,!1)}))}addEventListeners(){window.addEventListener("resize",this.handleResize.bind(this)),document.addEventListener("input",this.handleContentChange.bind(this)),document.addEventListener("change",this.handleContentChange.bind(this)),window.addEventListener("zoom",this.handleZoom.bind(this))}handleResize(){this.highlightText(!0)}handleContentChange(){this.highlightText(!1)}handleZoom(){this.highlightText(!0)}rerunHighlight(){this.highlightText(!1)}};S.styles={};var W=S;export{L as CircleRenderer,R as Color,A as HighlightRenderer,W as MarkerHighlighter,D as RectModel,F as RendererFactory,I as ScribbleRenderer,k as SketchoutRenderer,C as Utilities};
